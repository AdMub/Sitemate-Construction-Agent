from fpdf import FPDF
import datetime
import re
import pandas as pd

class PDFReport(FPDF):
    def header(self):
        self.set_font('Arial', 'B', 15)
        self.cell(0, 10, 'SiteMate Pro | Structural Analysis Report', 0, 1, 'C')
        self.ln(5)

    def footer(self):
        self.set_y(-15)
        self.set_font('Arial', 'I', 8)
        self.set_text_color(128)
        self.cell(0, 10, f'Generated by SiteMate Pro AI - Page {self.page_no()}', 0, 0, 'C')

def clean_text(text):
    """Sanitizes text for FPDF."""
    if not isinstance(text, str): return str(text)
    text = text.replace("₦", "N").replace("’", "'").replace("–", "-")
    text = re.sub(r'\*\*(.*?)\*\*', r'\1', text)
    text = re.sub(r'### ', '', text)
    return text.encode('latin-1', 'ignore').decode('latin-1')

def generate_pdf_report(user_query, location, soil_type, ai_text, boq_dataframe):
    pdf = PDFReport()
    pdf.add_page()
    pdf.set_auto_page_break(auto=True, margin=15)

    # --- 1. PROJECT CONTEXT ---
    pdf.set_fill_color(240, 240, 240)
    pdf.set_font('Arial', 'B', 12)
    pdf.cell(0, 10, '1. PROJECT CONTEXT', 0, 1, 'L', fill=True)
    pdf.set_font('Arial', '', 10)
    pdf.ln(2)
    pdf.cell(50, 8, f"Date: {datetime.date.today()}", 0, 1)
    pdf.cell(50, 8, f"Location: {clean_text(location)}", 0, 1)
    pdf.cell(50, 8, f"Soil: {clean_text(soil_type)}", 0, 1)
    pdf.ln(5)

    # --- 2. QUERY ---
    pdf.set_font('Arial', 'B', 12)
    pdf.cell(0, 10, '2. ENGINEER QUERY', 0, 1, 'L', fill=True)
    pdf.set_font('Arial', 'I', 10)
    pdf.multi_cell(0, 8, f'"{clean_text(user_query)}"')
    pdf.ln(5)

    # --- 3. AI ANALYSIS ---
    pdf.set_font('Arial', 'B', 12)
    pdf.cell(0, 10, '3. STRUCTURAL ANALYSIS', 0, 1, 'L', fill=True)
    pdf.set_font('Arial', '', 10)
    
    # Strip the old markdown table from the text
    text_body = ai_text
    if "|||" in ai_text: text_body = ai_text.split("|||")[0]
    elif "4. Bill of Quantities" in ai_text: text_body = ai_text.split("4. Bill of Quantities")[0]
    
    pdf.ln(2)
    pdf.multi_cell(0, 6, clean_text(text_body.strip()))
    pdf.ln(5)

    # --- 4. FINANCIAL BILL OF QUANTITIES ---
    if boq_dataframe is not None and not boq_dataframe.empty:
        pdf.set_font('Arial', 'B', 12)
        pdf.cell(0, 10, '4. FINANCIAL BILL OF QUANTITIES', 0, 1, 'L', fill=True)
        pdf.ln(2)

        # Header
        pdf.set_font('Arial', 'B', 9)
        pdf.set_fill_color(255, 140, 0) # Orange
        pdf.set_text_color(255)
        
        pdf.cell(40, 10, 'Item', 1, 0, 'C', fill=True)
        pdf.cell(65, 10, 'Description', 1, 0, 'C', fill=True)
        pdf.cell(15, 10, 'Qty', 1, 0, 'C', fill=True)
        pdf.cell(30, 10, 'Rate (N)', 1, 0, 'C', fill=True)
        pdf.cell(40, 10, 'Total (N)', 1, 1, 'C', fill=True)

        # Rows from DataFrame
        pdf.set_text_color(0)
        pdf.set_font('Arial', '', 9)
        
        grand_total = 0
        
        for _, row in boq_dataframe.iterrows():
            item = clean_text(str(row['Item']))
            # Truncate long descriptions
            desc = clean_text(str(row['Description']))[:35] 
            qty = str(row['Qty'])
            rate = f"{row['Unit Price']:,.0f}"
            total = f"{row['Total Cost']:,.0f}"
            grand_total += row['Total Cost']

            pdf.cell(40, 10, item, 1)
            pdf.cell(65, 10, desc, 1)
            pdf.cell(15, 10, qty, 1, 0, 'C')
            pdf.cell(30, 10, rate, 1, 0, 'R')
            pdf.cell(40, 10, total, 1, 1, 'R')

        # Total Row
        pdf.set_font('Arial', 'B', 10)
        pdf.cell(150, 10, 'ESTIMATED TOTAL:', 1, 0, 'R')
        pdf.set_fill_color(200, 255, 200) # Green
        pdf.cell(40, 10, f"N {grand_total:,.0f}", 1, 1, 'R', fill=True)

    pdf.ln(5)
    pdf.set_font('Arial', 'B', 8)
    pdf.set_text_color(200, 0, 0)
    pdf.multi_cell(0, 5, "DISCLAIMER: Prices are live estimates. Final costs depend on vendor negotiations.")

    return pdf.output(dest='S').encode('latin-1')